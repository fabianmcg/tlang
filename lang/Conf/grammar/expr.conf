Expr:
                TopExpr
       ;

TopExpr @<Expr>@:
                PrefExpr PPExpr         
                        :{
                            if (!_0)
                              _r = std::move(_1);
                            else {
                              (*_0)->getExpr() = *_1;
                              _r = std::move(_0);
                            }
                        }:
        ;

PPExpr @<Expr>@:
                PrimaryExpr PostfixExpr         
                        :{
                            if (!_1)
                              _r = std::move(_0);
                            else {
                              if (auto expr = dynamic_cast<CallExpr *>(*_1)) {
                                expr->getCallee() = *_0;
                                _r = std::move(_1);
                              }
                              else if (auto expr = dynamic_cast<ArrayExpr *>(*_1)) {
                                expr->getArray() = *_0;
                                _r = std::move(_1);
                              }
                              _r.range(_0.begin(), _1.end());
                            }
                        }:
       ;

PrimaryExpr @<Expr>@:
                DeclRefExpr         
                        :{
                            _r = std::move(_0);
                        }:
       |        ConstantExpr         
                        :{
                            _r = std::move(_0);
                        }:
       |        "(" Expr ")"         
                        :{
                            _r = create<return_t, false>(ParenExpr(*_1));
                            _r.range(_0.begin(), _2.end());
                        }:
       |        this         
                        :{
                            _r = create<return_t, false>(ThisExpr());
                        }:
       ;

PostfixExpr @<Expr>@ Predictive:
                CallExpr         
                        :{
                            _r = std::move(_0);
                        }:
       |        "[" ExprList "]"         
                        :{
                            _r = create<return_t, false>(ArrayExpr(std::move(*_1)));
                        }:
       |        "++"         
                        :{
                            _r;
                        }:
       |        "--"         
                        :{
                            _r;
                        }:
       |        E
       ;

CallExpr:
                "(" ExprList ")"         
                        :{
                            _r = make<return_t>(std::move(*_1));
                            _r.range(_0.begin(), _2.end());
                        }:
       ;

ExprList @<std::vector<Expr *>>@ static:
                Expr ExprListH         
                        :{
                            init(_r);
                            (*_r).push_back(*_0);
                            if (_1) {
                              for (auto &node : (*_1))
                                (*_r).push_back(node);
                            }
                        }:
       |        E         
                        :{
                            init(_r);
                        }:
       ;

ExprListH @<std::vector<Expr *>>@ static ZeroOrMore:
                CommaListExpr         
                        :{
                            init(_r);
                            (*_r).push_back(*_0);
                        }:
       ;

CommaListExpr @<Expr>@:
                "," Expr         
                        :{
                            _r = std::move(_1);
                        }:
       ;

PrefExpr @<UnaryOperation>@:
                "&"         
                        :{
                            _r = make<return_t>(Expr(), false, UnaryOperation::Address, nullptr);
                        }:
       |        
                "*"         
                        :{
                            _r = make<return_t>(Expr(), false, UnaryOperation::Dereference, nullptr);
                        }:
       |        "-"         
                        :{
                            _r = make<return_t>(Expr(), false, UnaryOperation::Minus, nullptr);
                        }:
       |        "+"         
                        :{
                            _r = make<return_t>(Expr(), false, UnaryOperation::Plus, nullptr);
                        }:
       |        E
       ;

PrefixExpr @<Expr>@:
                "+"         
                        :{
                            _r;
                        }:
       |        "-"         
                        :{
                            _r;
                        }:
       |        "!"         
                        :{
                            _r;
                        }:
       |        "*"         
                        :{
                            _r;
                        }:
       |        "~"         
                        :{
                            _r;
                        }:
       |        "++"         
                        :{
                            _r;
                        }:
       |        "--"         
                        :{
                            _r;
                        }:
       |        E
       ;

DeclRefExpr:
                Identifier         
                        :{
                            _r = make<return_t>(_0.value());
                            _r.range(_0.range());
                        }:
       ;

ConstantExpr @<Expr>@:
                IntLiteral         
                        :{
                            _r = create<return_t, false>(IntegerLiteral(get_qualType(IntType()), _0.value()));
                            _r.range(_0.range());
                        }:
       |        FloatLiteral         
                        :{
                            _r = create<return_t, false>(FloatLiteral(get_qualType(FloatType()), _0.value()));
                            _r.range(_0.range());
                        }:
       |        StringLiteral         
                        :{
                            _r = create<return_t, false>(StringLiteral(get_qualType(StringType()), _0.value()));
                            _r.range(_0.range());
                        }:
       ;

RangeExpr:
                Expr ":" Expr RangeExprAux         
                        :{
                            if (_3)
                              _r = make<return_t>(RangeExpr(Expr(), *_0, *_2, *_3));
                            else
                              _r = make<return_t>(RangeExpr(Expr(), *_0, nullptr, *_2));
                            _r.range(_0.range());
                        }:
       ;

RangeExprAux @<Expr>@:
                ":" Expr         
                        :{
                            _r = std::move(_1);
                            _r.range(_0.begin(), _1.end());
                        }:
       |        E
       ;
 
